<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas&#43;Neue&amp;display=swap" rel="stylesheet">
    <link href="style.css" rel="stylesheet">

        <script>
            var _products = [{
                "name":"Ex-presso",
                "ingredients":[
                    {"name": "Coffee Beans", "qty": 1},
                    {"name": "Bottle of Water", "qty": 2}],
                    "cost": 0,
                    "rrp": 65,
                    "type": "Coffee"},

                {"name":"Midnight Run",
                "ingredients":[
                    {"name": "Coffee Beans", "qty": 2
                    }],
                    "cost": 0,
                    "rrp": 60,
                    "type": "Coffee"
                },

                {"name":"Mochary of Justice",
                "ingredients":[
                    {"name": "Coffee Beans", "qty": 1},
                    {"name": "Milk", "qty": 1},
                    {"name": "Cocoa Bean", "qty": 1}],
                    "cost": 0,
                    "rrp": 75,
                    "type": "Coffee"
                },

                {"name":"Pale Imitation",
                    "ingredients":[
                        {"name": "Coffee Beans", "qty": 1},
                        {"name": "Liquid Whitener", "qty": 1},
                        {"name": "Milk", "qty": 1}],
                    "cost": 0,
                    "rrp": 75,
                    "type": "Coffee"
                },

                {"name":"Whiter Shade of Pale",
                    "ingredients":[
                        {"name": "Coffee Beans", "qty": 1},
                        {"name": "Liquid Whitener", "qty": 1},
                        {"name": "Milk", "qty": 1}],
                    "cost": 0,
                    "rrp": 75,
                    "type": "Coffee"},

                {"name":"Deja Brew",
                    "ingredients":[
                        {"name": "Milk", "qty": 1},
                        {"name": "Kopi Luwak Beans", "qty": 1},
                        {"name": "Cocoa Bean", "qty": 1}],
                        "cost": 0,
                        "rrp": 95,
                        "type": "Premium Coffee"},

                {"name":"Shot in the Dark",
                    "ingredients":[
                        {"name": "Kopi Luwak Beans", "qty": 1},
                        {"name": "Gunpowder", "qty": 1}],
                    "cost": 0,
                    "rrp": 95,
                    "type": "Premium Coffee"},

                {"name":"Broken Down Southside",
                    "ingredients":[
                        {"name": "Lime", "qty": 1},
                        {"name": "Basil", "qty": 1},
                        {"name": "Mint", "qty": 1},
                        {"name": "Bottle of Water", "qty": 1},
                        {"name": "Sugar", "qty": 1}],
                        "cost": 0,
                        "rrp": 105,
                        "type": "Spring Special"},
                {"name":"License to Chill",
                    "ingredients":[
                        {"name": "Lime", "qty": 1},
                        {"name": "Strawberry", "qty": 1},
                        {"name": "Orange", "qty": 1},
                        {"name": "Bottle of Water", "qty": 1},
                        {"name": "Sugar", "qty": 1}],
                        "cost": 0,
                        "rrp": 105,
                        "type": "Summer Special"},

                {"name":"Frighter Shade of Pale",
                    "ingredients":[
                        {"name": "Pumpkin", "qty": 1},
                        {"name": "Milk", "qty": 1},
                        {"name": "Coffee Beans", "qty": 1}],
                    "cost": 0,
                    "rrp": 85,
                    "type": "Fall Special"},

                {"name":"Sinner Man's Vice",
                    "ingredients":[
                        {"name": "Coffee Beans", "qty": 1},
                        {"name": "Milk", "qty": 1},
                        {"name": "Cinnamon", "qty": 1}],
                    "cost": 0,
                    "rrp": 85,
                    "type": "Winter Special"},

                {"name":"Cold Catalyst",
                    "ingredients":[
                        {"name": "Sugar", "qty": 1},
                        {"name": "Bottle of Water", "qty": 1},
                        {"name": "Coffee Beans", "qty": 1}],
                    "cost": 0,
                    "rrp": 65,
                    "type": "Granita"},

                {"name":"You Do Yuzu",
                    "ingredients":[
                        {"name": "Yuzu", "qty": 1},
                        {"name": "Bottle of Water", "qty": 1},
                        {"name": "Sugar", "qty": 1}],
                    "cost": 0,
                    "rrp": 65,
                    "type": "Granita"},

                {"name":"Bullet Times",
                    "ingredients":[],
                    "cost": 20,
                    "rrp": 40,
                    "type": "Snack"},
                {"name":"Centillionaire's Shortbread",
                    "ingredients":[],
                     "cost": 20,
                     "rrp": 40,
                     "type": "Snack"},
                {"name":"Frosted Cronuts",
                    "ingredients":[],
                    "cost": 20,
                    "rrp": 40,
                    "type": "Snack"},
                {"name":"Shock & Awe Financier",
                    "ingredients":[],
                    "cost": 20,
                    "rrp": 40,
                    "type": "Snack"},
                {"name":"Speedball",
                    "ingredients":[],
                    "cost": 20,
                    "rrp": 40,
                    "type": "Snack"},
                {"name":"Top Hole",
                    "ingredients":[],
                    "cost": 20,
                    "rrp": 40,
                    "type": "Snack"},
                {"name":"eCola", "ingredients":[], "cost": 10, "rrp": 100, "type": "Forbidden"},
                {"name":"eCola Light", "ingredients":[], "cost": 10, "rrp": 100, "type": "Forbidden"},
                {"name":"Sprunk", "ingredients":[], "cost": 10, "rrp": 100, "type": "Forbidden"},
                {"name":"Sprunk Light", "ingredients":[], "cost": 10, "rrp": 100, "type": "Forbidden"}];
                // {"name":"Whiskey", "ingredients":[], "cost": 50, "rrp": 95, "type": "Forbidden"},
                // {"name":"Vodka", "ingredients":[], "cost": 42, "rrp": 75, "type": "Forbidden"},
                // {"name":"Beer", "ingredients":[], "cost": 35, "rrp": 65, "type": "Forbidden"}];

            var _ingredients = [
                {"name": "Basil","cost": 20},
                {"name": "Bottle of Water", "cost": 10},
                {"name": "Coffee Beans", "cost": 20},
                {"name": "Cinnamon","cost": 20},
                {"name": "Cocoa Bean","cost": 20},
                {"name": "Gunpowder", "cost": 10},
                {"name": "Kopi Luwak Beans", "cost": 20},
                {"name": "Lemon","cost": 20},
                {"name": "Lime","cost": 20},
                {"name": "Liquid Whitener", "cost": 10},
                {"name": "Milk", "cost": 20},
                {"name": "Mint","cost": 20},
                {"name":"Pumpkin", "cost": 20},
                {"name":"Strawberry", "cost": 20},
                {"name": "Sugar", "cost": 10},
                {"name": "Yuzu","cost": 20},
            ];
            var _taxRate = 0.0999;
            var _discount = 0.1;

            var _order = {
                "products": [],
                "ingredients": [],
                "cost":0,
                "rrp":0,
                "charge":0,
                "tax":0,
                "net":0,
                "profit":0
            }

            var closeOnOrderConfirmation = true;
            var discountApplied = false;

            function calculateIngredientsCosts(ingredients)
            {
                var cost = 0;
                ingredients.forEach( ingredient => {
                    var found = _ingredients.find( (ing) => { return (ing.name == ingredient.name); } )
                    cost += found.cost * ingredient.qty;
                } );
                return cost;
            }

            function calculateOrder()
            {
                var cumulativeCost = 0;
                var cumulativeRrp = 0;
                for( var i=0; i < _order.products.length; ++i )
                {
                    cumulativeCost += calculateIngredientsCosts(_order.products[i].product.ingredients) * _order.products[i].qty;
                    cumulativeCost += _order.products[i].product.cost * _order.products[i].qty;
                    cumulativeRrp += _order.products[i].product.rrp * _order.products[i].qty;
                }

                _order.cost = cumulativeCost;
                _order.rrp = cumulativeRrp;
                _order.charge = _order.rrp;
                if( discountApplied )
                {
                  _order.charge -= Math.ceil(_order.rrp * _discount);
                }
            }

            function removeFromOrder(productIndex)
            {
                _order.products.splice(productIndex,1);
                updateOrder();
            }

            function getOrderItemQtyId(productName)
            {
                return productName + " order_qty";
            }

            function changeOrderItemQuantity( productName, newQty )
            {
                if( newQty == 0 )
                {
                    var index = _order.products.findIndex( item => item.product.name == productName )
                    if( index > -1 )
                    {
                        _order.products.splice(index, 1);
                        updateOrder();
                    }
                }
                else
                {
                    var foundItem = _order.products.find( item => (item.product.name == productName) );
                    if( foundItem ) {
                        foundItem.qty = Number(newQty);
                        updateOrder();
                    }
                }
            }

            function regenerateOrderList(order)
            {
                var orderList = document.getElementById("order-list");
                while (orderList.lastElementChild) {
                    orderList.removeChild(orderList.lastElementChild);
                }

                for( var i = 0; i < order.products.length; ++i )
                {
                    var rowDiv = document.createElement("li");
                    rowDiv.className = "order-list-row";
                    orderList.appendChild(rowDiv);

                    var nameDiv = document.createElement("div");
                    nameDiv.textContent = order.products[i].product.name;
                    rowDiv.appendChild(nameDiv);

                    var qtyInput = document.createElement("input");
                    qtyInput.setAttribute("type", "number");
                    qtyInput.id = getOrderItemQtyId(order.products[i].product.name);
                    qtyInput.className = "item-order-qty";
                    qtyInput.name = order.products[i].product.name;
                    qtyInput.value = Number(order.products[i].qty);
                    qtyInput.onchange = function(e) { changeOrderItemQuantity(e.target.name, Number(e.target.value)); }
                    rowDiv.appendChild(qtyInput);

                    var button = document.createElement("button");
                    button.classList.add("btn-remove");
                    button.value = i;
                    button.onclick = function() { removeFromOrder(this.value); };
                    rowDiv.appendChild(button);
                }
            }

            function regenerateIngredientsList(order)
            {
                var ingredientsList = document.getElementById("ingredients-list");
                while (ingredientsList.lastElementChild) {
                    ingredientsList.removeChild(ingredientsList.lastElementChild);
                }

                for( var i = 0; i < order.ingredients.length; ++i )
                {
                    var ingredientItem = document.createElement("li");
                    ingredientItem.textContent = "\xa0—\xa0" + order.ingredients[i].name + '\xa0×\xa0' + order.ingredients[i].qty;
                    ingredientsList.appendChild(ingredientItem);
                }
            }

            function addItem()
            {
                var productSelection = document.getElementById("product-selection").value;
                if( productSelection == "Select Product" ) { return; }
                var productIndex = Number(productSelection);
                var productQuantity = Number(document.getElementById("product-quantity").value);
                if( productQuantity <= 0 ) { return; }
                var itemToAdd = { "product": _products[productIndex], "qty":productQuantity }

              _order.products.push( itemToAdd );

                updateOrder();
            }

            function updateIngredientsList()
            {
                _order.ingredients = [];

                for(var productIndex=0; productIndex < _order.products.length; ++productIndex)
                {
                    var product = _order.products[productIndex].product;
                    var qty = _order.products[productIndex].qty;

                    for(var ingIndex = 0; ingIndex < product.ingredients.length; ++ingIndex)
                    {
                        var ingredient = product.ingredients[ingIndex];
                        var foundIndex = _order.ingredients.findIndex( (ing) => { return ing.name == ingredient.name; } );
                        if( foundIndex >= 0 )
                        {
                            _order.ingredients[foundIndex].qty += ingredient.qty * qty;
                        }
                        else
                        {
                            _order.ingredients.push( { "name": ingredient.name, "qty": ingredient.qty * qty  } );
                        }
                    }
                }
            }

            function updateOrderDetails(order)
            {
                document.getElementById("order-cost").innerHTML = order.cost;
                document.getElementById("order-rrp").innerHTML = order.rrp;
                document.getElementById("order-charge").value = order.charge;
            }

            function updateOrder()
            {
                updateIngredientsList();
                calculateOrder();
                regenerateOrderList(_order);
                regenerateIngredientsList(_order);
                updateOrderDetails(_order);
            }

            function addProductSelection(products)
            {
                var selection = document.getElementById("product-selection");

                for( var i=0; i < products.length; ++i )
                {
                    var option = document.createElement("option");
                    option.textContent = products[i].name;
                    option.value = i;
                    selection.appendChild(option);
                }
            }

            function confirmOrder()
            {
              if( _order.products.length > 0 )
              {
                _order.charge = document.getElementById("order-charge").value;
                _order.tax = Math.floor(_taxRate * _order.charge);
                _order.net = _order.charge - _order.tax;
                _order.profit = _order.net - _order.cost;
                              }
              else
              {
                alert("No items in order, please add items or cancel")
              }
            }
            function addItemByName(productName)
            {
                var foundProduct = _products.find( item => item.name == productName )
                if( foundProduct == null ) {
                    return;
                }

                var productQuantity = 1;
                var itemToAdd = { "product": foundProduct, "qty":productQuantity }


                var foundIndex = _order.products.findIndex( item => (item.product.name == foundProduct.name) );
                if( foundIndex < 0 ) {

                    _order.products.push( itemToAdd );
                }
                else {
                    _order.products[foundIndex].qty += productQuantity;
                }
                updateOrder();
            }

            function applyStyle(productElement, productType)
            {
                productElement.classList.add("btn-product");

                switch( productType )
                {
                    case "Coffee":
                        productElement.classList.add("btn--coffee");
                        break;
                    case "Premium Coffee":
                        productElement.classList.add("btn--premium-coffee");
                        break;
                    case "Granita":
                        productElement.classList.add("btn--granita");
                        break;
                    case "Snack":
                        productElement.classList.add("btn--snack");
                        break;
                    case "Forbidden":
                        productElement.classList.add("btn--forbidden");
                        break;
                    case "Spring Special":
                        productElement.classList.add("btn--spring-special");
                        break;
                    case "Summer Special":
                        productElement.classList.add("btn--summer-special");
                        break;
                    case "Fall Special":
                        productElement.classList.add("btn--fall-special");
                        break;
                    case "Winter Special":
                        productElement.classList.add("btn--winter-special");
                        break;
                }
            }

            function addProductSelectionGrid(products)
            {
                var selection = document.getElementById("product-selection-grid");

                for( var i=0; i < products.length; ++i )
                {
                    var option = document.createElement("button");
                    applyStyle( option, products[i].type );
                    option.id = products[i].name;
                    option.textContent = products[i].name;
                    option.onclick = function(e) {
                        addItemByName( e.target.id );
                    }
                    selection.appendChild(option);
                }
            }

            function resetOrder()
            {
                _order.products.splice(0, _order.products.length);
                updateOrder();
            }

            function onLoad()
            {
                addProductSelectionGrid(_products);

                var confirmButton = document.getElementById("confirmButton");
                if( confirmButton )
                {
                    confirmButton.addEventListener("click", confirmOrder);
                }

                var closeSetting = document.getElementById("closeSetting");
                if( closeSetting )
                {
                    closeSetting.addEventListener("change", function(){ closeOnOrderConfirmation = !this.checked; });
                }

                var discountSetting = document.getElementById('discountSetting');
                if( discountSetting )
                {
                  discountSetting.checked = discountApplied;
                  discountSetting.addEventListener("change", function(){ discountApplied = this.checked; updateOrder(); });
                }
            }
        </script>
  </head>
  <body onload="onLoad()">
    <div id="logo-container">
      <img src="logo.png" alt="Bean Machine Logo" />
      <h1>Bean Machine EPOS System v2.0</h1>
    </div>
    <div id="epos-container">
        <div id="products-and-ingredients">
            <div id="product-selection-grid"></div>
            <div id="ingredients-panel">
                <h2>Ingredients Required:</h2>
                <ul id="ingredients-list"></ul>
            </div>
        </div>
        <div id="order-contents">
            <h2>Order Contents:</h2>
            <ul id="order-list"></ul>
            <div class="order-totals">
                <label for="order-cost" class="totals-label">Total Cost: </label>
                <div id="order-cost" class="totals-input"></div>
                <div>&nbsp;</div>
                <label for="order-rrp" class="totals-label">Total RRP: </label>
                <div id="order-rrp" class="totals-input"></div>
                <div>&nbsp;</div>
                <label for="order-charge" class="totals-label">Charge: </label>
                <input type="number" class="totals-input" id="order-charge" min="0" />
                <div>&nbsp;</div>
            </div>
        </div>
    </div>
    </body>
</html>
